#include <stdio.h>
#include <stdlib.h>

typedef long long ll;

ll power(ll base, ll exp, ll mod) {
    ll res = 1;
    base %= mod;
    while (exp > 0) {
        if (exp % 2 == 1) res = (res * base) % mod;
        base = (base * base) % mod;
        exp /= 2;
    }
    return res;
}

ll gcd(ll a, ll b) {
    if (b == 0)
        return a;
    return gcd(b, a % b);
}

ll modInverse(ll e, ll phi) {
    ll m0 = phi, t, q;
    ll x0 = 0, x1 = 1;

    if (phi == 1) return 0;

    while (e > 1) {
        q = e / phi;
        t = phi;
        phi = e % phi, e = t;
        t = x0;
        x0 = x1 - q * x0;
        x1 = t;
    }

    if (x1 < 0)
       x1 += m0;

    return x1;
}

int main() {
    ll p, q;
    ll n, phi;
    ll e, d;
    ll msg, c, decrypted_msg;

    printf("--- Key Generation ---\n");
    printf("Enter the first prime number (p): ");
    scanf("%lld", &p);
    printf("Enter the second prime number (q): ");
    scanf("%lld", &q);

    n = p * q;
    phi = (p - 1) * (q - 1);
    printf("Calculated n = p*q = %lld\n", n);
    printf("Calculated phi(n) = (p-1)*(q-1) = %lld\n", phi);

    while (1) {
        printf("Enter public exponent (e) (must be coprime to %lld): ", phi);
        scanf("%lld", &e);

        if (e > 1 && e < phi && gcd(e, phi) == 1) {
            break;
        }
        printf("Invalid 'e'. It must be 1 < e < %lld and gcd(e, %lld) must be 1.\n", phi, phi);
    }
    
    d = modInverse(e, phi);

    printf("\n--- Keys ---");
    printf("\nPublic Key (PU) = {e, n} = {%lld, %lld}\n", e, n);
    printf("Private Key (PR) = {d, n} = {%lld, %lld}\n", d, n);

    printf("\n--- Encryption ---\n");
    printf("Enter a message (M) to encrypt (as a number < %lld): ", n);
    scanf("%lld", &msg);
    
    if (msg >= n) {
        printf("Error: Message must be smaller than n (%lld).\n", n);
        return 1;
    }

    c = power(msg, e, n);
    printf("Encrypted Ciphertext (C) = %lld\n", c);

    printf("\n--- Decryption ---\n");
    decrypted_msg = power(c, d, n);
    printf("Decrypted Message (M) = %lld\n", decrypted_msg);

    printf("\n--- Verification ---\n");
    if (msg == decrypted_msg) {
        printf("Success: The original message and decrypted message are identical.\n");
    } else {
        printf("Error: Decryption failed.\n");
    }

    return 0;
}
